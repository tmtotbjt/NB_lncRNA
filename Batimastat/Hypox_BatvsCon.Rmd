 Hypox Control (Batimastat vs Control Hypox salygomis)

```{r}
library(pacman)
p_load(rtracklayer, GenomicRanges, dplyr, data.table, dplyr, DESeq2, ggplot2, ggrepel, tidyr, 
      readxl, biomaRt, clusterProfiler, org.Hs.eg.db, DT, ChIPseeker, TxDb.Hsapiens.UCSC.hg38.knownGene, 
      pheatmap, flashClust, ggraph, ComplexHeatmap, gridExtra, grid)
knitr::opts_chunk$set(fig.width=6, fig.height=6, echo = T)
pthres <- 0.1
lfc <- log2(1.25)
source("~/NB_lncRNA/code/BioInsights/more_code.R")
```

```{r}
tmp <-  readRDS("~/NB_lncRNA/output/code/lncRNA/DataQC/data2DEG.RDS")
sampleInfo <- tmp[[2]]
samples2do <- c("T1cH1", "T1cH2", "T1H1", "K7H1", "K7H2", "K7cH1", "K7cH2")
sampleInfo <- sampleInfo[Barcode %in% samples2do, ] 
sampleInfo$Group <- sampleInfo$Treatment
```
```{r}
DT::datatable(sampleInfo[, .(sample, Group)], class = 'cell-border stripe')
```

```{r}
list_of_4 <- tmp[[1]]
counts_lnc <- list_of_4[[2]]
counts_lnc <- counts_lnc[, samples2do]

dds <- readRDS("~/NB_lncRNA/output/code/BioInsights/Bastimat/dds_lnc_HBC.RDS")
vsd <- assay(vst(dds)) %>% as.data.table(., keep.rownames=TRUE) 

mat <- vsd[,-1]
mat <- as.matrix(mat)
rownames(mat) <- vsd$rn

res <- results(dds) %>% as.data.table(., keep.rownames=TRUE) 

sig_lncRNAs <- subset(res, pvalue < 0.01 & abs(log2FoldChange) > 1.25)
sig_lncRNAs <- sig_lncRNAs[order(sig_lncRNAs$padj), ]
sig_lncRNAs$gene_id <- rownames(sig_lncRNAs)
sig_lncRNAs <- as.data.frame(sig_lncRNAs)
#rownames(sig_lncRNAs) <- sub("\\..*$", "", rownames(sig_lncRNAs))
mat_filt_lnc <- mat[rownames(mat) %in% sig_lncRNAs$rn, ]
rownames(mat_filt_lnc) <- sub("\\..*$", "", rownames(mat_filt_lnc))
```

```{r}
#Protein coding
duomenys <- readRDS("~/NB_lncRNA/input/data2DEG_protein.RDS")

list_of_4 <- duomenys[[1]]
counts_pc <- list_of_4[[2]]
counts_pc <- counts_pc[, samples2do]

dds <- readRDS("~/NB_lncRNA/output/code/BioInsights/Bastimat/dds_pc_HBC.RDS")
vsd_pc <- vst(dds)
mat_pc <- assay(vsd_pc)
res_pc <- results(dds) %>% as.data.table(., keep.rownames=TRUE)

sig <- subset(res_pc, pvalue < 0.05 & abs(log2FoldChange) >= 2)
sig <- sig[order(sig$padj), ]
sig <- as.data.frame(sig)
mat_filt_pc <- mat_pc[rownames(mat_pc) %in% sig$rn, ]
rownames(mat_filt_pc) <- sub("\\..*$", "", rownames(mat_filt_pc))
```

# Bendras mėginių pasižiūrėjimas {.tabset}
## Heatmap
```{r}
annotation_col <- data.frame(Group = sampleInfo$Group)
ann_colors = list(Group = c(Batimastat="cyan", control="lightpink"))
p1 <- pheatmap(mat_filt_pc,
         scale = "row",
         annotation_col = annotation_col,
         annotation_colors = ann_colors,
         show_rownames = FALSE,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         main = "mRNA",
         silent = TRUE)

p2 <- pheatmap(mat_filt_lnc,
         scale = "row",
         annotation_col = annotation_col,
         annotation_colors = ann_colors,
         show_rownames = FALSE,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         main= "lncRNA",
         silent = TRUE)
```

```{r, fig.height = 7, fig.width=18}
rownames(annotation_col) <- sampleInfo$Barcode
mat <- rbind(mat_filt_lnc, mat_filt_pc)
p3 <- pheatmap(mat,
         scale = "row",
         annotation_col = annotation_col,
         annotation_colors = ann_colors,
         show_rownames = FALSE,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         main= "bendras",
         silent = TRUE)

g1 <- grid.grabExpr(draw(p1))
g2 <- grid.grabExpr(draw(p2))
g3 <- grid.grabExpr(draw(p3))

gridExtra::grid.arrange(g1, g2, g3, ncol = 3)
```

## Koreliacija pagal mėginius

```{r, fig.height= 10, fig.width = 18}
countai <- rbind(counts_lnc, counts_pc)
countai_group <- countai[, c(1, 2, 6, 7, 3, 4, 5)]
counts_lnc_group <- counts_lnc[, c(1, 2, 6, 7, 3, 4, 5)]
counts_pc_group <- counts_pc[, c(1, 2, 6, 7, 3, 4, 5)]

a <- get_cor(counts_lnc_group, title = "lncRNA")
b <-get_cor(counts_pc_group, title = "mRNA")
c <-get_cor(countai_group, title = "Bendras")

a | b| c
```

## PCA

```{r}
#get_pca(mat_filt_lnc, sampleInfo) + ggtitle("tik lncRNA")
#get_pca(mat_filt_pc, sampleInfo)+ ggtitle("tik mRNA")
get_pca(mat, sampleInfo) + ggtitle("Bendras")

```

# Pakitę baltymą koduojantys genai

```{r}
sig_lnc_up <- subset(sig_lncRNAs, padj < 0.05 & log2FoldChange > 1)
sig_lnc_down <- subset(sig_lncRNAs, padj < 0.05 & log2FoldChange < -1)
sig_pc_up <- subset(sig, padj < 0.05 & log2FoldChange >= log2(2))
sig_pc_down <- subset(sig, padj < 0.05 & log2FoldChange <= (-1)*log2(2))
```

```{r, fig.width=12}
pc_names <- rownames(mat_pc)
rownames(sig_pc_up) <- sub("\\..*$", "", sig_pc_up$rn)
pc_names <- sub("\\..*$", "", pc_names)
ego <- enrichGO(gene          = rownames(sig_pc_up),
                universe      = pc_names,
                OrgDb         = "org.Hs.eg.db",
                ont           = "BP",
                pAdjustMethod = "none",
                pvalueCutoff  = 0.05,
                keyType       = "ENSEMBL",
                readable      = TRUE)
c <- dotplot(ego, showCategory=10) + ggtitle("GO padidėjusios raiškos")

rownames(sig_pc_down) <- sub("\\..*$", "", sig_pc_down$rn)
ego <- enrichGO(gene          = rownames(sig_pc_down),
                universe      = pc_names,
                OrgDb         = "org.Hs.eg.db",
                ont           = "BP",
                pAdjustMethod = "none",
                pvalueCutoff  = 0.05,
                key           = "ENSEMBL",
                readable      = TRUE)
d <- dotplot(ego, showCategory=10) + ggtitle("GO sumažėjusios raiškos")

c|d
```

# Genominis kontekstas (šalia lncRNA esantys genai) {.tabset}

lncRNA lgali reguliuoti šalia esančių genų raišą. Stebima kokie yra šalia esantys pakitę baltymą koduoajntys genai.

## Šalia lncRNA esantys baltymą koduojantys genai
```{r}
lncGR <- readRDS("~/NB_lncRNA/output/code/BioInsights/Bastimat/lncGR_HBC.RDS") #padarytas su siglncRNAs
#geneGR <- readRDS("~/NB_lncRNA/output/code/BioInsights/geneGR.RDS")
```
lncRNA genai, jų genominė padėtis ir artimiausi baltymą koduojantys kaimyniniai genai su atstumu iki jų.
Genominė padėtis:

- Antisense - persidengia su baltymą koduojančiu genu, bet priešingoje grandinėje.

- Sense Overlapping - persidengia su baltymą koduojančiu genu toje pačioje grandinėje.

- Bidirectional - priešingos krypties nei artimiausias baltymą koduojantis genas (šalia jo reguliacinių elementų).

- Intergenic - lncRNA tarp baltymą koduojančių genų.
```{r}
#final_table <- get_near_table(lncGR, geneGR)
final_table <- read.csv("~/NB_lncRNA/output/code/BioInsights/Bastimat/distance_HBC.csv")
table(final_table$genomic_context)
```

## Šalia lncRRNA esantys pakitę baltymą koduojantys genai
```{r}
geneGR <- readRDS("~/NB_lncRNA/output/code/BioInsights/Bastimat/geneGR_HBC.RDS")
final_table <- final_table[final_table$nearest_protein_coding_gene %in% geneGR$gene_name, ]

datatable(final_table, class = 'cell-border stripe', , rownames = FALSE)
table(final_table$genomic_context)
```


## Šalia (100kb) lncRNA esančių baltymą koduojančių GO enrichment
```{r}
# Artimiausi genai (cis, within 100kb)
# cituojant D Avalos (2023) — For distances between 50 kb and 1Mb between co-expressed gene pairs
nearest_genes <- distanceToNearest(lncGR, geneGR)
cis_genes <- geneGR[subjectHits(nearest_genes)][mcols(nearest_genes)$distance <= 50000]
cis_gene_names <- unique(cis_genes$gene_id)
cis_gene_names <- sub("\\..*$", "", cis_gene_names)

go_res <- enrichGO(gene = cis_gene_names,
                   OrgDb = org.Hs.eg.db,
                   keyType = "ENSEMBL",
                   ont = "BP",
                   pvalueCutoff = 0.05)
go_res <- as.data.frame(go_res) %>% dplyr::select(Procesai = Description)
go_res
```


# Koreliacija {.tabset}
## Pagal raišką

```{r}
cor_matrix <- cor(t(mat_filt_lnc), t(mat_filt_pc), method = "spearman")
cor_df <- reshape2::melt(cor_matrix)
colnames(cor_df) <- c("lncRNA", "mRNA", "value")
pheatmap(cor_matrix,
         clustering_distance_rows = "euclidean",
         clustering_distance_cols = "euclidean",
         show_rownames = FALSE,
         show_colnames = FALSE)
```


## Stipriai koreliuojančių su lncRNA mRNA funckinė anotacija
```{r}
# Pasidaryti atskirus tegiamai ir neigiamai koreliuojantiems (?)
cor_df_sig <- subset(cor_df, abs(value) > 0.85)

rownames(sig_lnc_up) <- sub("\\..*$", "", rownames(sig_lnc_up))
rownames(sig_lnc_down) <- sub("\\..*$", "", rownames(sig_lnc_down))

#sudaro klasterius
genes <- unique(as.character(cor_df_sig$mRNA[cor_df_sig$lncRNA %in% rownames(mat_filt_lnc)]))
```

```{r}
ego <- enrichGO(genes, OrgDb = org.Hs.eg.db, keyType = "ENSEMBL", ont = "BP")
dotplot(ego, showCategory=10) + ggtitle("Koreliuojantys bendrai")
```


# Protein-protein interaction network construction, module analysis
Sąveikaujančių baltymų grupių anotacijos.

```{r, fig.width=10}
ego_list <- readRDS("~/NB_lncRNA/output/code/BioInsights/Bastimat/GO_en_mod_HBC.RDS")

module_annotation <- do.call(
  rbind,
  lapply(names(ego_list), function(m) {
    eg <- ego_list[[m]]
    if (is.null(eg) || nrow(eg@result) == 0) return(NULL)

  head(data.frame( Module = m, eg@result[, c("Description", "p.adjust")]), 3)}))

module_labels <- aggregate(Description ~ Module, module_annotation, function(x) x[1])

ggplot(module_annotation, aes(x = Module, y = Description, size = -log10(p.adjust), color = -log10(p.adjust))) +
  geom_point() +
  scale_color_viridis_c() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title = element_blank()) +
  labs(title = "GO Biological Process enrichment of PPI modules")
```
