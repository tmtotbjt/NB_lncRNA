```{r}
library(pacman)
p_load(rtracklayer, GenomicRanges, dplyr, data.table, dplyr, DESeq2, ggplot2, ggrepel, tidyr, 
      readxl, biomaRt, clusterProfiler, org.Hs.eg.db, DT, ChIPseeker, TxDb.Hsapiens.UCSC.hg38.knownGene, 
      pheatmap, flashClust, ggraph, ComplexHeatmap, gridExtra, grid)
knitr::opts_chunk$set(fig.width=6, fig.height=6, echo = T)
pthres <- 0.1
lfc <- log2(1.25)
source("~/NB_lncRNA/code/BioInsights/more_code.R")
```

```{r}
duomenys <-  readRDS("~/NB_lncRNA/output/code/lncRNA/DataQC/data2DEG.RDS")
sampleInfo <- duomenys[[2]]
samples2do <- c("K7Cu1", "K7Cu2", "K7c241", "K7c242", "K12Cu1", "K12Cu2", "K12c1", "K12c2")
sampleInfo <- sampleInfo[Barcode %in% samples2do, ]
sampleInfo$Group <- sampleInfo$Treatment
```
```{r}
DT::datatable(sampleInfo[, .(sample, Treatment, POSNEG)], class = 'cell-border stripe')
```

```{r}
list_of_4 <- duomenys[[1]]
counts_lnc <- list_of_4[[2]]
counts_lnc <- counts_lnc[, samples2do]


dds <- readRDS("~/NB_lncRNA/output/code/BioInsights/dds_cur_lnc.RDS")
vsd <- assay(vst(dds)) %>% as.data.table(., keep.rownames=TRUE) 

mat <- vsd[,-1]
mat <- as.matrix(mat)
rownames(mat) <- vsd$rn

res <- results(dds) %>% as.data.table(., keep.rownames=TRUE) 

sig_lncRNAs <- subset(res, pvalue < 0.05 & abs(log2FoldChange) > 1.25)
sig_lncRNAs <- sig_lncRNAs[order(sig_lncRNAs$padj), ]
sig_lncRNAs$gene_id <- rownames(sig_lncRNAs)
sig_lncRNAs <- as.data.frame(sig_lncRNAs)
#rownames(sig_lncRNAs) <- sub("\\..*$", "", rownames(sig_lncRNAs))
mat_filt_lnc <- mat[rownames(mat) %in% sig_lncRNAs$rn, ]
rownames(mat_filt_lnc) <- sub("\\..*$", "", rownames(mat_filt_lnc))
```

```{r}
#Protein coding
duomenys <- readRDS("~/NB_lncRNA/input/data2DEG_protein.RDS")

list_of_4 <- duomenys[[1]]
counts_pc <- list_of_4[[2]]
counts_pc <- counts_pc[, samples2do]

dds <- readRDS("~/NB_lncRNA/output/code/BioInsights/dds_cur_pc.RDS")
vsd_pc <- vst(dds)
mat_pc <- assay(vsd_pc)
res_pc <- results(dds) %>% as.data.table(., keep.rownames=TRUE)

sig <- subset(res_pc, pvalue < 0.05 & abs(log2FoldChange) >= 1.25)
sig <- sig[order(sig$padj), ]
sig <- as.data.frame(sig)
mat_filt_pc <- mat_pc[rownames(mat_pc) %in% sig$rn, ]
rownames(mat_filt_pc) <- sub("\\..*$", "", rownames(mat_filt_pc))
```


# Bendras mėginių pasižiūrėjimas {.tabset}
## Heatmap
```{r}
annotation_col <- data.frame(Group = sampleInfo$Group)
ann_colors = list(Group = c(Curaxin="cyan", control="lightpink"))
p1 <- pheatmap(mat_filt_pc,
         scale = "row",
         annotation_col = annotation_col,
         annotation_colors = ann_colors,
         show_rownames = FALSE,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         main = "mRNA",
         silent = TRUE)

p2 <- pheatmap(mat_filt_lnc,
         scale = "row",
         annotation_col = annotation_col,
         annotation_colors = ann_colors,
         show_rownames = FALSE,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         main= "lncRNA",
         silent = TRUE)
```


```{r, fig.height = 7, fig.width=18}
rownames(annotation_col) <- sampleInfo$Barcode
mat <- rbind(mat_filt_lnc, mat_filt_pc)
p3 <- pheatmap(mat,
         scale = "row",
         annotation_col = annotation_col,
         annotation_colors = ann_colors,
         show_rownames = FALSE,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         main= "bendras",
         silent = TRUE)

g1 <- grid.grabExpr(draw(p1))
g2 <- grid.grabExpr(draw(p2))
g3 <- grid.grabExpr(draw(p3))

gridExtra::grid.arrange(g1, g2, g3, ncol = 3)
```

## PCA ir koreliacija pagal mėginius
Atfiltravus pakitusios raiškos genus mėginiai atsiskiria pagal poveikio grupę.
```{r}
mat <- rbind(mat_filt_lnc, mat_filt_pc)
get_pca(mat, sampleInfo) + ggtitle("Bendras")
```

Iš visų genų raiškos (ne filtruojant) matoma, jog mėginaii atsiskiria pagal kitą grupę.
```{r, fig.height= 10, fig.width = 18}
countai <- rbind(counts_lnc, counts_pc)

a <- get_cor(counts_lnc, title = "lncRNA")
b <- get_cor(counts_pc, title = "mRNA")
c <- get_cor(countai, title = "Bendras")

a | b| c
```

# Pakitę baltymą koduojantys genai

```{r}
sig_lnc_up <- subset(sig_lncRNAs, padj < 0.05 & log2FoldChange > 1)
sig_lnc_down <- subset(sig_lncRNAs, padj < 0.05 & log2FoldChange < -1)
sig_pc_up <- subset(sig, padj < 0.05 & log2FoldChange >= log2(2))
sig_pc_down <- subset(sig, padj < 0.05 & log2FoldChange <= (-1)*log2(2))
```

```{r, fig.width=12}
pc_names <- rownames(mat_pc)
rownames(sig_pc_up) <- sub("\\..*$", "", sig_pc_up$rn)
pc_names <- sub("\\..*$", "", pc_names)
ego <- enrichGO(gene          = rownames(sig_pc_up),
                universe      = pc_names,
                OrgDb         = "org.Hs.eg.db",
                ont           = "BP",
                pAdjustMethod = "none",
                pvalueCutoff  = 0.05,
                keyType       = "ENSEMBL",
                readable      = TRUE)
c <- dotplot(ego, showCategory=10) + ggtitle("GO padidėjusios raiškos")

rownames(sig_pc_down) <- sub("\\..*$", "", sig_pc_down$rn)
ego <- enrichGO(gene          = rownames(sig_pc_down),
                universe      = pc_names,
                OrgDb         = "org.Hs.eg.db",
                ont           = "BP",
                pAdjustMethod = "none",
                pvalueCutoff  = 0.05,
                key           = "ENSEMBL",
                readable      = TRUE)
d <- dotplot(ego, showCategory=10) + ggtitle("GO sumažėjusios raiškos")

c|d

ensembl_ids <-  rownames(sig_pc_up)
entrezID <- mapIds(
  org.Hs.eg.db,
  keys = ensembl_ids,
  column = "ENTREZID",
  keytype = "ENSEMBL",
  multiVals = "first")

entrezID <- na.omit(entrezID)
kegg <- enrichKEGG(gene         = entrezID,
                   organism     = 'hsa',
                   pvalueCutoff = 0.05)
a <- dotplot(kegg, showCategory=10) +ggtitle("KEGG su padidėjusios raiškos genais")

ensembl_ids <-  rownames(sig_pc_down)
entrezID <- mapIds(
  org.Hs.eg.db,
  keys = ensembl_ids,
  column = "ENTREZID",
  keytype = "ENSEMBL",
  multiVals = "first")

entrezID <- na.omit(entrezID)
kegg <- enrichKEGG(gene         = entrezID,
                   organism     = 'hsa',
                   pvalueCutoff = 0.05)
b <- dotplot(kegg, showCategory=10) +ggtitle("KEGG su sumažėjusios raiškos genais")

a | b
```


# Genominis kontekstas (šalia lncRNA esantys genai) {.tabset}
lncRNA lgali reguliuoti šalia esančių genų raišą. Stebima kokie yra šalia esantys pakitę baltymą koduoajntys genai.

## Šalia lncRNA esantys baltymą koduojantys genai
```{r}
lncGR <- readRDS("~/NB_lncRNA/output/code/BioInsights/Curoxin_vs_Control/lncGR_Cu_Co.RDS")
#geneGR <- readRDS("~/NB_lncRNA/output/code/BioInsights/geneGR.RDS")
```

lncRNA genai, jų genominė padėtis ir artimiausi baltymą koduojantys kaimyniniai genai su atstumu iki jų.
Genominė padėtis:

- Antisense - persidengia su baltymą koduojančiu genu, bet priešingoje grandinėje.

- Sense Overlapping - persidengia su baltymą koduojančiu genu toje pačioje grandinėje.

- Bidirectional - priešingos krypties nei artimiausias baltymą koduojantis genas (šalia jo reguliacinių elementų).

- Intergenic - lncRNA tarp baltymą koduojančių genų.


Kadangi pagal poveikį atsirinktas pakankmai mažas genų skaičius, didžioji dalis lncRNA 
(beiveik visos) yra intergeninės.
```{r}
#final_table <- get_near_table(lncGR, geneGR)
final_table <- read.csv("~/NB_lncRNA/output/code/BioInsights/Curoxin_vs_Control/distance.csv")
table(final_table$genomic_context)
```


## Šalia lncRRNA esantys pakitę baltymą koduojantys genai
```{r}
geneGR <- readRDS("~/NB_lncRNA/output/code/BioInsights/Curoxin_vs_Control/geneGR_Cu_Co.RDS")
final_table <- final_table[final_table$nearest_protein_coding_gene %in% geneGR$gene_name, ]

datatable(final_table, class = 'cell-border stripe', , rownames = FALSE)
table(final_table$genomic_context)
```

## Šalia (100kb) lncRNA esančių baltymą koduojančių GO enrichment
```{r}
# Artimiausi genai (cis, within 100kb)
# cituojant D Avalos (2023) — For distances between 50 kb and 1Mb between co-expressed gene pairs
nearest_genes <- distanceToNearest(lncGR, geneGR)
cis_genes <- geneGR[subjectHits(nearest_genes)][mcols(nearest_genes)$distance <= 50000]
cis_gene_names <- unique(cis_genes$gene_id)
cis_gene_names <- sub("\\..*$", "", cis_gene_names)

go_res <- enrichGO(gene = cis_gene_names,
                   universe = pc_names,
                   OrgDb = org.Hs.eg.db,
                   keyType = "ENSEMBL",
                   ont = "BP",
                   pvalueCutoff = 0.05)
go_res <- as.data.frame(go_res) %>% dplyr::select(Procesai = Description)
go_res
```

# Koreliacija pagal raišką {.tabset}
Matoma, jog yra tarpusavyje koreliuojančių lncRNA su mRNA (matomas grupių susidarymas)
```{r}
cor_matrix <- cor(t(mat_filt_lnc), t(mat_filt_pc), method = "spearman")
cor_df <- reshape2::melt(cor_matrix)
colnames(cor_df) <- c("lncRNA", "mRNA", "value")
pheatmap(cor_matrix,
         clustering_distance_rows = "euclidean",
         clustering_distance_cols = "euclidean",
         show_rownames = FALSE,
         show_colnames = FALSE)
```


## Stipriai koreliuojančių su lncRNA mRNA funckinė anotacija
```{r}
cor_df_sig <- subset(cor_df, abs(value) > 0.75)

genes <- unique(as.character(cor_df_sig$mRNA))
genes <- sub("\\..*$","", genes)

ego <- enrichGO(genes, OrgDb = org.Hs.eg.db, keyType = "ENSEMBL", ont = "BP")
dotplot(ego, showCategory=10) + ggtitle("Koreliuojantys bendrai")
```


## Atskirai tarp klonų sudarius koreliacijas

```{r}
cor_df1 <- readRDS("~/NB_lncRNA/output/code/BioInsights/Curoxin_vs_Control/cor_df_7.RDS")
cor_df2 <- readRDS("~/NB_lncRNA/output/code/BioInsights/Curoxin_vs_Control/cor_df_12.RDS")
cor_sig1 <- subset(cor_df1, abs(value) > 0.8)
cor_sig2 <- subset(cor_df2, abs(value) > 0.8)

poros_1 <- cor_sig1[, c("lncRNA", "mRNA")]
poros_2 <- cor_sig2[, c("lncRNA", "mRNA")]

common_pairs <- inner_join(poros_1, poros_2, by = c("lncRNA", "mRNA"))
unique_pc <- unique(common_pairs$mRNA)
unique_pc <- sub("\\..*$", "", unique_pc)
```


```{r}
entrezID <- mapIds(
  org.Hs.eg.db,
  keys = unique_pc,
  column = "ENTREZID",
  keytype = "ENSEMBL",
  multiVals = "first")

entrezID <- na.omit(entrezID)

kegg <- enrichKEGG(gene         = entrezID,
                   organism     = 'hsa',
                   pvalueCutoff = 0.05)
kegg_proc <- as.data.frame(kegg) %>% dplyr::select(Procesai = Description)
kegg_proc
```


```{r}
# moduliai neišėjo (Stipriai nepatikimi ir mažai)
```

