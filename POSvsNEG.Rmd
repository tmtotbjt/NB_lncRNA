```{r}
library(pacman)
p_load(rtracklayer, GenomicRanges, dplyr, data.table, dplyr, DESeq2, ggplot2, ggrepel, tidyr, 
      readxl, igraph, biomaRt, clusterProfiler, org.Hs.eg.db, DT, ChIPseeker, TxDb.Hsapiens.UCSC.hg38.knownGene, 
      pheatmap, flashClust, ggraph, ComplexHeatmap)
knitr::opts_chunk$set(fig.width=6, fig.height=6, echo = T)
pthres <- 0.1
lfc <- log2(1.25)
source("~/NB_lncRNA/code/BioInsights/more_code.R")
```

```{r}
#lncRNA
dds_list <- readRDS("~/NB_lncRNA/output/code/lncRNA/NEG_VS_POS/POS_vs_NEG.RDS")
dge_id <- dds_list[["res"]] %>% as.data.table(., keep.rownames=TRUE) %>% .[padj <= pthres & abs(log2FoldChange) >= lfc, rn]
res <- dds_list[["res"]]
counts <- counts(dds_list[["dds"]]) %>% as.data.table
vst_counts <- assay(dds_list[["vsd"]]) %>% as.data.table(., keep.rownames=TRUE) 
rownames(counts) <- vst_counts$rn
mat <- vst_counts[,-1]
mat <- as.matrix(mat)
rownames(mat) <- vst_counts$rn
# <- mat[,c("K7cN1", "K7cN2", "K12c1", "K12c2")]

tmp <-  readRDS("~/NB_lncRNA/output/code/lncRNA/DataQC/data2DEG.RDS")
sampleInfo <- tmp[[2]]
#samples2do <- c("K7cN1", "K7cN2", "K12c1", "K12c2")
samples2do <- c("K7cN1", "K7cN2", "K12c1", "K12c2", "T1cN1", "T1cN2", "NeNR1", "NeNR2")
sampleInfo <- sampleInfo[Barcode %in% samples2do, ] 
sampleInfo$Group <- sampleInfo$POSNEG


sig_lncRNAs <- subset(res, padj < 0.05 & abs(log2FoldChange) > 1.25)
sig_lncRNAs <- sig_lncRNAs[order(sig_lncRNAs$padj), ]
sig_lncRNAs$gene_id <- rownames(sig_lncRNAs)
sig_lncRNAs <- as.data.frame(sig_lncRNAs)
#rownames(sig_lncRNAs) <- sub("\\..*$", "", rownames(sig_lncRNAs))
mat_filt_lnc <- mat[rownames(mat) %in% rownames(sig_lncRNAs), ]
rownames(mat_filt_lnc) <- sub("\\..*$", "", rownames(mat_filt_lnc))
```

```{r}
#Protein coding
duomenys <- readRDS("~/NB_lncRNA/input/data2DEG_protein.RDS")

list_of_4 <- duomenys[[1]]
counts_pc <- list_of_4[[2]]
counts_pc <- counts_pc[, samples2do]
length <- list_of_4[[3]]
sampleInfo <- sampleInfo[c(7, 8, 1, 2, 5, 6, 3, 4),]

dds <- DESeqDataSetFromMatrix(countData = round(counts_pc), 
                              colData = sampleInfo, 
                              design = ~POSNEG)
dds <- DESeq(dds)
vsd_pc <- vst(dds)
mat_pc <- assay(vsd_pc)
res_pc <- results(dds) %>% as.data.table(., keep.rownames=TRUE)

sig <- subset(res_pc, padj < 0.05 & abs(log2FoldChange) >= 1.25)
sig <- sig[order(sig$padj), ]
sig <- as.data.frame(sig)
mat_filt_pc <- mat_pc[rownames(mat_pc) %in% sig$rn, ]
rownames(mat_filt_pc) <- sub("\\..*$", "", rownames(mat_filt_pc))
```

Kaip kinta mRNA ir lncRNA tarp mėginių (ar yra atsiskyrimas pagal abu)

```{r}
annotation_col <- data.frame(Group = sampleInfo$Group)
ann_colors = list(Group = c(NEG="cyan", POS="lightpink"))
pheatmap(mat_filt_pc,
         scale = "row",
         annotation_col = annotation_col,
         annotation_colors = ann_colors,
         show_rownames = FALSE,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         main = "mRNA")

pheatmap(mat_filt_lnc,
         scale = "row",
         annotation_col = annotation_col,
         annotation_colors = ann_colors,
         show_rownames = FALSE,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         main= "lncRNA")
```


# Bendrai enrichment {.tabset}
## lncRNA enrichment
lncRNA praturtinimas rodo bendrai, jog reguliuoja genų raišką (jungimasis su miRNA, RNR, baltymais/dalyvauja baltymų kompleksų susidaryme) 

```{r}
sig_lnc_up <- subset(sig_lncRNAs, padj < 0.05 & log2FoldChange > 1)
sig_lnc_down <- subset(sig_lncRNAs, padj < 0.05 & log2FoldChange < -1)
sig_pc_up <- subset(sig, padj < 0.05 & log2FoldChange >= log2(2))
sig_pc_down <- subset(sig, padj < 0.05 & log2FoldChange <= (-1)*log2(2))


gene_list <- sub("\\..*$", "", rownames(sig_lncRNAs))
gene_list_all  <- sub("\\..*$", "", rownames(res))
go_enrich <- enrichGO(gene_list, OrgDb="org.Hs.eg.db", keyType="ENSEMBL")

go_enrich <- as.data.frame(go_enrich) %>% dplyr::select(Procesai = Description)
go_enrich
```

## Pakitę baltymą koduojantys genai

Didžiąja dalimi pc genai yra sumažėjusios raiškos.

```{r, fig.width=12}
lnc_names <- rownames(mat)
pc_names <- rownames(mat_pc)
geneList_all <- c(lnc_names, pc_names)
geneList_all <- sub("\\..*$", "", geneList_all)

rownames(sig_pc_up) <- sub("\\..*$", "", sig_pc_up$rn)
ego <- enrichGO(gene          = rownames(sig_pc_up),
                universe      = geneList_all,
                OrgDb         = org.Hs.eg.db,
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                key           = "ENSEMBL",
                readable      = TRUE)
c <- dotplot(ego, showCategory=10) + ggtitle("GO padidėjusios raiškos")

rownames(sig_pc_down) <- sub("\\..*$", "", sig_pc_down$rn)
ego <- enrichGO(gene          = rownames(sig_pc_down),
                universe      = geneList_all,
                OrgDb         = org.Hs.eg.db,
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                key           = "ENSEMBL",
                readable      = TRUE)
d <- dotplot(ego, showCategory=10) + ggtitle("GO sumažėjusios raiškos")

c|d


geneList <- res_pc$log2FoldChange
geneList_pc <- sub("\\..*$", "", res_pc$rn)
names(geneList) <- geneList_pc
geneList <- na.omit(geneList)
geneList <- geneList[!duplicated(names(geneList))]
geneList <- sort(geneList, decreasing = TRUE)

gse <- gseGO(geneList = geneList,
             OrgDb = org.Hs.eg.db,
             keyType = "ENSEMBL",
             ont = "BP")
a <- dotplot(gse, showCategory=5, split=".sign") + facet_grid(.~.sign) + ggtitle("GO")

ensembl_ids <- names(geneList)
entrezID <- mapIds(
  org.Hs.eg.db,
  keys = ensembl_ids,
  column = "ENTREZID",
  keytype = "ENSEMBL",
  multiVals = "first"
)
entrezID <- na.omit(entrezID)
geneList_entrez <- geneList[names(entrezID)] 
names(geneList_entrez) <- as.character(entrezID)
gene_names <- names(geneList_entrez)
geneList_entrez <- sort(geneList_entrez, decreasing = TRUE)
geneList_entrez <- geneList_entrez[!duplicated(names(geneList_entrez))]

kk2 <- gseKEGG(geneList     = geneList_entrez,
               organism     = 'hsa',
               pvalueCutoff = 0.05)
b <- dotplot(kk2, showCategory=5, split=".sign") + facet_grid(.~.sign) + ggtitle("KEGG")

a | b
```

# Genominis kontekstas (šalia lncRNA esantys genai) {.tabset}

lncRNA lgali reguliuoti šalia esančių genų raišą. Stebima kokie yra šalia esantys genai.

## Šalia lncRNA esantys baltymą koduojantys genai
```{r}
lncGR <- readRDS("~/NB_lncRNA/output/code/BioInsights/lncGR.RDS") #padarytas su siglncRNAs
geneGR <- readRDS("~/NB_lncRNA/output/code/BioInsights/filt_geneGR.RDS") #sig pakitę pc RNA (log 1.25)


nearest_idx <- nearest(lncGR, geneGR)
nearest_gene <- geneGR$gene_name[nearest_idx]
distance_to_pc <- distance(lncGR, geneGR[nearest_idx])
genomic_context <- rep("intergenic", length(lncGR))

gene_upstream <- promoters(geneGR, upstream=1500, downstream=0)
hits <- findOverlaps(lncGR, gene_upstream, ignore.strand=FALSE)
qh <- queryHits(hits)
sh <- subjectHits(hits)

lnc_strand <- as.character(strand(lncGR[qh]))
gene_strand <- as.character(strand(geneGR[sh]))
lnc_tss <- start(lncGR[qh])
gene_tss <- ifelse(gene_strand == "+", start(geneGR[sh]), end(geneGR[sh]))
bidir_hit <- (gene_strand == "+" & lnc_tss < gene_tss & (gene_tss - lnc_tss) <= 2000) |
                        (gene_strand == "-" & lnc_tss > gene_tss & (lnc_tss - gene_tss) <= 2000)
bidir <- unique(qh[bidir_hit])
genomic_context[bidir] <- "bidirectional"


hits <- findOverlaps(lncGR, geneGR, ignore.strand=TRUE)
qh <- queryHits(hits)
sh <- subjectHits(hits)
lnc_strand <- as.character(strand(lncGR[qh]))
gene_strand <- as.character(strand(geneGR[sh]))

close_to_gene <- distance_to_pc[qh] <= 10000
is_antisense_hit <- (lnc_strand != gene_strand) & close_to_gene
antisense_idx <- setdiff(unique(qh[is_antisense_hit]), bidir)
genomic_context[antisense_idx] <- "antisense"

is_sense_hit <- lnc_strand == gene_strand
sense_idx <- setdiff(unique(qh[is_sense_hit]), c(bidir, antisense_idx))
genomic_context[sense_idx] <- "sense_overlapping"
```

lncRNA genai, jų genominė padėtis ir artimiausi baltymą koduojantys kaimyniniai genai su atstumu iki jų.
Genominė padėtis:
- Antisense - persidengia su baltymą koduojančiu genu, bet priešingoje grandinėje.
- Sense Overlapping - persidengia su baltymą koduojančiu genu toje pačioje grandinėje.
- Bidirectional - priešingos krypties nei artimiausias baltymą koduojantis genas (šalia jo reguliacinių elementų).
- Intergenic - lncRNA tarp baltymą koduojančių genų.

```{r}
final_table <- data.frame(
  lncRNA = lncGR$gene_name,
  genomic_context = genomic_context,
  nearest_protein_coding_gene = nearest_gene,
  distance = distance_to_pc)
final_table <- final_table[!duplicated(final_table[c("lncRNA", "nearest_protein_coding_gene", "distance")]), ]
final_table <- final_table %>%
  group_by(lncRNA, nearest_protein_coding_gene) %>%
  slice_min(distance) %>%
  ungroup()
#final <- unique( final_table[ , c(1, 4, 5, 6) ] )
datatable(final_table, class = 'cell-border stripe', , rownames = FALSE)
table(final_table$genomic_context)
ctx_df <- as.data.frame(table(final_table$genomic_context))
colnames(ctx_df) <- c("genomic_context", "count")
ggplot(ctx_df, aes(x = genomic_context, y = count, fill = genomic_context)) +
  geom_col() +
  geom_label(aes(label = count),
             fill = "white",
             color = "black",
             size = 4,
             label.size = 0.7,
             show.legend = FALSE) +
  coord_flip() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.15))) +
  labs(x = "Genomic context", y = "Count", title= "Genominis kontekstas DE lncRNA") +
  theme_minimal(base_size = 14) +
  theme(axis.text.y = element_text(size = 15),
        axis.title = element_text(size = 15),
        legend.position = "none",
        plot.title = element_text(size=15))
```


```{r}
# Artimiausi genai (cis, within 100kb)
# cituojant D Avalos (2023) — For distances between 50 kb and 1Mb between co-expressed gene pairs
nearest_genes <- distanceToNearest(lncGR, geneGR)
cis_genes <- geneGR[subjectHits(nearest_genes)][mcols(nearest_genes)$distance <= 100000]
cis_gene_names <- unique(cis_genes$gene_id)
cis_gene_names <- sub("\\..*$", "", cis_gene_names)

lnc_names <- rownames(mat)
pc_names <- rownames(mat_pc)
geneList_all <- c(lnc_names, pc_names)
geneList_all <- sub("\\..*$", "", geneList_all)

entrez_ids <- bitr(cis_gene_names, fromType = "ENSEMBL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
entrez_ids_all <- bitr(geneList_all, fromType = "ENSEMBL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)


go_res <- enrichGO(gene = entrez_ids$ENTREZID,
                   universe = entrez_ids_all$ENTREZID,
                   OrgDb = org.Hs.eg.db,
                   ont = "BP",
                   pvalueCutoff = 0.1)
dotplot(go_res)+ ggtitle("GO praturtinimo analizė")
```


# Koreliacija {.tabset}

## Pagal mėginius
(iš visų)
```{r}
counts <- rbind(counts, counts_pc)
counts <- counts[, c(1, 2, 5, 6, 3, 4, 7, 8)]
cor_mat <- cor(counts)
cor_df <- reshape2::melt(cor_mat)
colnames(cor_df) <- c("Var1", "Var2", "value")

ggplot(cor_df, aes(x = Var1, y = Var2, fill = value)) +
        geom_tile(color = "white") +
        labs(title="B", fill= " ")+
        scale_fill_gradientn(
        colors = c("blue", "white", "red"),
        limits = c(min(cor_df$value), max(cor_df$value))) +
        theme(
        plot.title = element_text(size = 20, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 16, face = "bold", angle = 90, vjust = 0.5, hjust = 1),
        axis.text.y = element_text(size = 16, face = "bold")) +
        coord_fixed()

#get_pca(mat_filt_lnc) + ggtitle("tik lncRNA")
#get_pca(mat_filt_pc)+ ggtitle("tik mRNA")
mat_all <- rbind(mat_filt_lnc, mat_filt_pc)
get_pca(mat_all, sampleInfo) + ggtitle("Bendras")

```


## Pagal raišką
```{r}
# pearson sutinkama straipsniuose, bet yra kad siūlo spearman
cor_matrix <- cor(t(mat_filt_lnc), t(mat_filt_pc), method = "spearman")
cor_df <- reshape2::melt(cor_matrix)
colnames(cor_df) <- c("lncRNA", "mRNA", "value")
cor_df_sig <- subset(cor_df, abs(value) > 0.75)
pheatmap(cor_matrix,
         clustering_distance_rows = "euclidean",
         clustering_distance_cols = "euclidean",
         show_rownames = FALSE,
         show_colnames = FALSE)

```

(iš atrinktų lncRNA ir mRNA)
```{r}
annotation_col <- data.frame(Group = sampleInfo$Group)
rownames(annotation_col) <- sampleInfo$Barcode
mat <- rbind(mat_filt_lnc, mat_filt_pc)

ann_colors = list(Group = c(NEG="cyan", POS="lightpink"))
pheatmap(mat,
         scale = "row",
         annotation_col = annotation_col,
         annotation_colors = ann_colors,
         show_rownames = FALSE,
         cluster_rows = TRUE,
         cluster_cols = TRUE)
```

## Stipriai koreliuojančių su lncRNA mRNA funckinė anotacija
```{r}
cor_matrix <- cor(t(mat_filt_lnc), t(mat_filt_pc), method = "spearman")
cor_df <- reshape2::melt(cor_matrix)
colnames(cor_df) <- c("lncRNA", "mRNA", "value")
# Pasidaryti atskirus tegiamai ir neigiamai koreliuojantiems (?)
cor_df_sig <- subset(cor_df, abs(value) > 0.85)


rownames(sig_lnc_up) <- sub("\\..*$", "", rownames(sig_lnc_up))
rownames(sig_lnc_down) <- sub("\\..*$", "", rownames(sig_lnc_down))

#sudaro klasterius (visi)
genes <- unique(as.character(cor_df_sig$mRNA[cor_df_sig$lncRNA %in% rownames(mat_filt_lnc)]))
#sudaro klasterius su padidėjusios raiškos lncRNA
genes_p <- unique(as.character(cor_df_sig$mRNA[cor_df_sig$lncRNA %in% rownames(sig_lnc_up)]))
#sudaro klasterius su sumažėjusios raiškos lncRNA
genes_s <- unique(as.character(cor_df_sig$mRNA[cor_df_sig$lncRNA %in% rownames(sig_lnc_down)]))
```

```{r}
#daug overlap'ų (1470), paimti tik unique
unique_p <- setdiff(genes_p, genes_s)
unique_s <- setdiff(genes_s, genes_p)

ego <- enrichGO(genes, OrgDb = org.Hs.eg.db, keyType = "ENSEMBL", ont = "BP")
dotplot(ego, showCategory=10) + ggtitle("Koreliuojantys bendrai")
```

# Protein-protein interaction network construction, hub gene selection, and module analysis
```{r}
geneGR_df <- as.data.frame(geneGR)
geneGR_df <- geneGR_df %>%
  distinct(gene_id, .keep_all = TRUE)
sig_with_symbol <- sig %>%
  left_join(geneGR_df %>% 
  dplyr::select(gene_id, gene_name), by = c("rn" = "gene_id"))
sig_with_symbol$rn <- sub("\\..*$","", sig_with_symbol$rn)
#sig_with_symbol <- sig_with_symbol[sig_with_symbol$rn %in% genes,]
ens2sym <- sig_with_symbol$gene_name
names(ens2sym) <- sig_with_symbol$rn
new_names <- ens2sym[rownames(mat_filt_pc)]
keep <- !is.na(new_names)

mat_filt_pc_sym <- mat_filt_pc[keep, ]
rownames(mat_filt_pc_sym) <- new_names[keep]
```

```{r}
final_hits <- readRDS("~/NB_lncRNA/output/code/BioInsights/final_hits.RDS")
ppi <- read.csv("~/NB_lncRNA/output/code/BioInsights/PPI_modules.csv")
modules <- split(ppi$Gene, ppi$Module)

library(igraph)
module_expr <- lapply(modules, function(genes) {
  genes <- intersect(genes, rownames(mat_filt_pc_sym))
  if (length(genes) < 2) return(NULL)
  colMeans(mat_filt_pc_sym[genes, , drop = FALSE]) })

module_expr <- module_expr[!sapply(module_expr, is.null)]
module_expr <- do.call(rbind, module_expr)
rownames(module_expr) <- paste0("Module_", rownames(module_expr))
final_hits$Module <- paste0("Module_", final_hits$Module)

edges <- final_hits[abs(final_hits$rho) >= 0.9 & final_hits$perm_pval <= 0.01,]
lncGR$gene_id <- sub("\\..*$", "", lncGR$gene_id)
lnc_map <- setNames(
  lncGR$gene_name,
  lncGR$gene_id)
edges$lncRNA_symbol <- lnc_map[edges$lncRNA]


edge_df <- data.frame(
  from   = edges$lncRNA_symbol,
  to     = edges$Module,
  weight = abs(edges$rho),
  sign   = ifelse(edges$rho > 0, "positive", "negative"))

g_lnc_mod <- graph_from_data_frame(
  edge_df,
  directed = FALSE)

V(g_lnc_mod)$type <- ifelse(
  grepl("^Module_", V(g_lnc_mod)$name),
  "Module",
  "lncRNA")
V(g_lnc_mod)$degree <- degree(g_lnc_mod)

V(g_lnc_mod)$size <- ifelse(
  V(g_lnc_mod)$type == "lncRNA",
  6 + V(g_lnc_mod)$degree * 2,
  12)

V(g_lnc_mod)$color <- ifelse(
  V(g_lnc_mod)$type == "lncRNA",
  "#aa5967",
  "darkcyan")

E(g_lnc_mod)$color <- ifelse(
  edge_df$sign == "positive",
  "lightgreen",
  "midnightblue"
)

E(g_lnc_mod)$width <- edge_df$weight * 3

plot(
  g_lnc_mod,
  layout = layout_with_fr,
  vertex.label.cex = 0.7,
  vertex.frame.color = "white",
  main = "lncRNA–PPI Module Network"
)
```

```{r}
ego_list <- readRDS("~/NB_lncRNA/output/code/BioInsights/GO_enrichment_all_modules.RDS")

module_annotation <- do.call(
  rbind,
  lapply(names(ego_list), function(m) {
    eg <- ego_list[[m]]
    if (is.null(eg) || nrow(eg@result) == 0) return(NULL)

  head(data.frame( Module = m, eg@result[, c("Description", "p.adjust")]), 3)}))

module_labels <- aggregate(Description ~ Module, module_annotation, function(x) x[1])

ggplot(module_annotation, aes(x = Module, y = Description, size = -log10(p.adjust), color = -log10(p.adjust))) +
  geom_point() +
  scale_color_viridis_c() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title = element_blank()) +
  labs(title = "GO Biological Process enrichment of PPI modules")

#module_labels$Module <- paste0("Module_", module_labels$Module)
#lncRNA_linked <- merge(final_hits, module_labels, by = "Module")
```
